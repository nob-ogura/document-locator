# 生成AIとベクトル検索を活かしたGoogle Drive検索システム (PoC: 概念実証版)

## はじめに
本ドキュメントは、「生成AIとベクトル検索を活用した次世代のGoogle Drive検索システム」の**概念実証（Proof of Concept）**を目的とする。

コンセプトの核となる価値（権限を遵守したセキュアなセマンティック検索）を迅速に検証するため、実装範囲を**最小限の実行可能な構成（MVP: Minimum Viable Product）**に絞り込み、過剰な実装を避けた計画を定義する。

## セキュリティと権限に関する基本設計
本システムは、マルチユーザー環境での利用を前提としており、Google Driveにおける各ユーザーの閲覧権限を厳格に遵守する。システム設計の核として、以下の権限モデルを採用する。

*   **検索の起点**: すべての検索は、操作しているユーザー自身のGoogleアカウント認証情報を用いて開始される。
*   **権限フィルタリング**: 検索時には、まずユーザーの権限が適用された状態で `felores/gdrive-mcp-server` を呼び出し、閲覧可能なファイルIDのリストを取得する。
*   **対象スコープの固定化**: PoCのクロール/検索対象は `.env` に記述した `GOOGLE_DRIVE_TARGET_FOLDER_ID` 配下のフォルダに限定し、それ以外の共有ドライブ／マイドライブはクロールしない。

この設計により、ユーザーが本来アクセスできないファイルのメタデータ（ファイル名、要約文など）が決して検索結果に表示されないことを保証し、情報漏洩のリスクを排除する。

## 外部サービス構成
1.  **LLM / Embeddings**:
    *   推論用: GPT-4o mini
    *   ベクトル化用: text-embedding-3-small
2.  **DB**: Supabase
    *   拡張機能 `pgvector` を有効化
    *   テーブル定義:
        *   `file_id`: Google DriveのファイルID
        *   `file_name`: ファイル名
        *   `summary`: ファイル要約文
        *   `keywords`: キーワード配列
        *   `embedding`: vector型（要約文とキーワードをベクトル化したデータ）
        *   `updated_at`: 最終更新日時

## 実装内容

### 1. Google Drive クローラー (CLI / Cron)
Google Driveを定期的に巡回し、検索用インデックス（DB）を構築・更新する、システムの土台となる機能。

*   **プロセス**:
    0.  **ターゲットフォルダの解決**:
        *   `.env` の `GOOGLE_DRIVE_TARGET_FOLDER_ID` を読み込み、`felores/gdrive-mcp-server` で存在確認を行う。
            *   区切り文字 `,` で複数のターゲットフォルダを設定できる。
        *   フォルダが見つからない場合や権限が不足している場合は即座に失敗させ、誤ったスコープでクロールを開始しない。
    1.  **変更リストの取得（差分検出の効率化）**:
        *   初回のみ: `files.list`で全件取得。
        *   初回以降: Google Drive APIの`changes.list`エンドポイントと、前回保存した**Start Page Token**を使用し、変更（新規作成・更新・削除）があったファイルのリストのみを効率的に取得する。これにより、全件スキャンに伴うAPI負荷と処理時間を削減する。
    2.  **同期処理**:
        *   **新規・更新ファイル**: リスト内の新規・更新ファイルを対象に、後述のAI処理を実行する。
        *   **削除済みファイル**: リスト内の削除済みファイルIDを使い、DBから対応するレコードを削除する。
    3.  **AI処理**:
        *   対象ファイルのテキストコンテンツを抽出。 *(注: GoogleドキュメントやPDF等のテキスト情報を主対象とし、画像ファイル内の文字列抽出（OCR）は今回の対象外とする。)*
        *   GPT-4o mini で「ファイル要約文」と「検索用キーワード」を生成。
        *   text-embedding-3-small で「要約文 + キーワード + ファイル名」を結合したテキストから「ベクトル（Embedding）」を生成。
    4.  **保存と状態更新**:
        *   AI処理後のすべての情報をSupabaseのテーブルにUpsert（挿入・更新）する。
        *   次回のクロールに備え、新しい**Start Page Token**をDBに保存する。

    *(注: クローラーはターゲットフォルダ配下のみをインデックス化するが、フォルダが共有ドライブ配下にあるため管理者権限を持つサービスアカウント等での実行を想定。個々のユーザーの検索時には、後述の検索フローで各ユーザーの閲覧権限に基づいたフィルタリングが必ず適用される。)*

### 2. セマンティック検索プログラム (CLI)
CLIアプリケーションとして実装する。概念実証（PoC）の段階では、複雑な分岐ロジックは実装せず、中核機能である「権限を考慮したセマンティック検索」が有効であることを証明するシンプルな構成とする。

*   **検索フロー**:
    1.  **クエリ解析 & 権限に基づいた初期検索**:
        *   コマンドライン引数、または対話形式でユーザーの自然文クエリを受け付ける。
        *   クエリから日付指定があれば抽出し、期間フィルタ(`updated_at`)を用意する。
        *   GPT-4o miniに対し、固有名詞、プロジェクト名、ファイル形式などを優先するよう指示したプロンプトを用いて、**検索キーワードを最大3件抽出**させる。
        *   *(権限への配慮: 抽出したキーワードと期間フィルタを使い、ユーザー自身の認証情報で `felores/gdrive-mcp-server` の全文検索を実行する。これにより、ユーザーが閲覧権限を持つファイルのみが候補としてヒットする)*

    2.  **結果件数に応じた分岐ロジック**:
        *   **ヒット数が 101件以上 の場合 (対話によるキーワード絞り込み)**:
            *   ヒットした上位結果の傾向をGPT-4o miniに分析させ、絞り込むための「追加の質問」を生成し、コンソール上でユーザーに回答を求める。
            *   ユーザーのキーボード入力から、絞り込みに有効な追加キーワードを1件抽出するようGPT-4o miniに指示する。
            *   元のキーワードと追加キーワードを組み合わせ、再度 `felores/gdrive-mcp-server` で全文検索（権限チェックを兼ねる）を実行し、結果を標準出力へ提示する。
        *   **ヒット数が 31件 〜 100件 の場合 (ベクトル検索)**:
            *   `felores/gdrive-mcp-server` でヒットしたファイル群のファイルIDの集合をフィルターとして使用し、Supabase DB内でベクトル検索を実行。これにより、クエリとの関連性が高い上位30件程度に絞り込む。
        *   **ヒット数が 11件 〜 30件 の場合 (LLMによる絞り込み)**:
            *   取得したファイル情報をコンテキストとして GPT-4o mini に渡し、「ユーザーの質問意図に最も合致するもの」を10件選定させる。
        *   **ヒット数が 1件 〜 10件 の場合 (LLMによるリランキング)**:
            *   取得したファイル情報をコンテキストとして GPT-4o mini に渡し、「ユーザーの質問意図に合致する順」にソートする。
            *   ソート後ファイル情報に基づき、ファイル名・要約文・Google Driveリンクと共に標準出力へ一覧表示する。
        *   **ヒット数が 0件 の場合 (キーワードの自動調整)**:
            *   ユーザーに意識させることなく、シームレスに検索キーワードを減らして再検索を実行し、検索ヒット数を上げる。
            *   検索キーワードが1件になってもヒット数が0件の場合は「見つかりませんでした」とコンソールに出力して終了する。
        *   上記の処理を実行した後、結果件数に応じて再度この分岐ロジックを適用する。
