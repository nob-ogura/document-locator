# 生成AIとベクトル検索を活かしたGoogle Drive検索システム (MVC: 最小概念実証版)

## はじめに
本ドキュメントは、「生成AIとベクトル検索を活用した次世代のGoogle Drive検索システム」の**概念実証（Proof of Concept）**を目的とする。

コンセプトの核となる価値（権限を遵守したセキュアなセマンティック検索）を迅速に検証するため、実装範囲を**最小限の実行可能な構成（MVC: Minimum Viable Concept）**に絞り込み、過剰な実装を避けた計画を定義する。

## セキュリティと権限に関する基本設計
本システムは、マルチユーザー環境での利用を前提としており、Google Driveにおける各ユーザーの閲覧権限を厳格に遵守する。システム設計の核として、以下の権限モデルを採用する。

*   **検索の起点**: すべての検索は、操作しているユーザー自身のGoogleアカウント認証情報を用いて開始される。
*   **権限フィルタリング**: 検索時には、まずユーザーの権限が適用された状態でGoogle Drive APIを呼び出し、閲覧可能なファイルIDのリストを取得する。
*   **安全なDBアクセス**: Supabaseに構築したインデックス（要約、キーワード、ベクトル情報）の検索は、**必ず上記で取得したファイルIDのリストでフィルタリングしてから実行する**。
*   **対象スコープの固定化**: PoCのクロール/検索対象は `.env` に記述した `GOOGLE_DRIVE_TARGET_FOLDER_ID` 配下のフォルダに限定し、それ以外の共有ドライブ／マイドライブはクロールしない。

この設計により、ユーザーが本来アクセスできないファイルのメタデータ（ファイル名、要約文など）が決して検索結果に表示されないことを保証し、情報漏洩のリスクを排除する。

## 外部サービス構成
1.  **LLM / Embeddings**:
    *   推論用: GPT-4o mini
    *   ベクトル化用: text-embedding-3-small
2.  **DB**: Supabase
    *   拡張機能 `pgvector` を有効化
    *   テーブル定義:
        *   `file_id`: Google DriveのファイルID
        *   `file_name`: ファイル名
        *   `summary`: ファイル要約文
        *   `keywords`: キーワード配列
        *   `embedding`: vector型（要約文とキーワードをベクトル化したデータ）
        *   `updated_at`: 最終更新日時
        *   `last_modifier`: 最終更新ユーザー名

## 実装内容

### 1. Google Drive クローラー (CLI / Cron)
Google Driveを定期的に巡回し、検索用インデックス（DB）を構築・更新する、システムの土台となる機能。

*   **プロセス**:
    0.  **ターゲットフォルダの解決**:
        *   `.env` の `GOOGLE_DRIVE_TARGET_FOLDER_ID` を読み込み、Google Drive APIで存在確認とメタデータ取得（親ドライブID、名前）を行う。
        *   フォルダが見つからない場合や権限が不足している場合は即時に失敗させ、誤ったスコープでクロールを開始しない。
    1.  **変更リストの取得（差分検出の効率化）**:
        *   初回のみ: `files.list`で全件取得。
        *   初回以降: Google Drive APIの`changes.list`エンドポイントと、前回保存した**Start Page Token**を使用し、変更（新規作成・更新・削除）があったファイルのリストのみを効率的に取得する。これにより、全件スキャンに伴うAPI負荷と処理時間を削減する。
    2.  **同期処理**:
        *   **新規・更新ファイル**: リスト内の新規・更新ファイルを対象に、後述のAI処理を実行する。
        *   **削除済みファイル**: リスト内の削除済みファイルIDを使い、DBから対応するレコードを削除する。
    3.  **AI処理**:
        *   対象ファイルのテキストコンテンツを抽出。 *(注: GoogleドキュメントやPDF等のテキスト情報を主対象とし、画像ファイル内の文字列抽出（OCR）は今回の対象外とする。)*
        *   GPT-4o mini で「ファイル要約文」と「検索用キーワード」を生成。
        *   text-embedding-3-small で「要約文 + キーワード + ファイル名」を結合したテキストから「ベクトル（Embedding）」を生成。
    4.  **保存と状態更新**:
        *   AI処理後のすべての情報をSupabaseのテーブルにUpsert（挿入・更新）する。
        *   次回のクロールに備え、新しい**Start Page Token**をDB等に保存する。

    *(注: クローラーはターゲットフォルダ配下のみをインデックス化するが、フォルダが共有ドライブ配下にあるため管理者権限を持つサービスアカウント等での実行を想定。個々のユーザーの検索時には、後述の検索フローで各ユーザーの閲覧権限に基づいたフィルタリングが必ず適用される。)*

### 2. セマンティック検索プログラム (CLI)
CLIアプリケーションとして実装する。概念実証（PoC）の段階では、複雑な分岐ロジックは実装せず、中核機能である「権限を考慮したセマンティック検索」が有効であることを証明するシンプルな構成とする。

*   **検索フロー**:
    1.  **クエリ受付**:
        *   コマンドライン引数、または対話形式でユーザーの自然文クエリを受け付ける。
    2.  **権限フィルタの準備**:
        *   ユーザー自身の認証情報でGoogle Drive APIを呼び出し、`.env` で設定した `GOOGLE_DRIVE_TARGET_FOLDER_ID` 配下でユーザーが閲覧権限を持つファイルIDのリストのみを取得する。`'folderId' in parents` 形式でクエリを固定し、それ以外のファイルはそもそも候補に入れない。
        *   *(UXへの配慮: この処理中、コンソールには「閲覧可能なファイルをチェック中...」といったメッセージを表示。)*
    3.  **セマンティック検索の実行**:
        *   ユーザーのクエリを text-embedding-3-small でベクトル化する。
        *   Supabaseに対し、**ステップ2で取得したファイルIDのリストで絞り込み**を行った上で、クエリのベクトルとの類似度が最も高いレコードを検索（ベクトル検索）する。
    4.  **結果の表示**:
        *   取得したファイル情報を、ファイル名、要約文、Google Driveリンクと共に、類似度の高い順に標準出力へ一覧表示する。

### 3. 段階的な実装計画 (ロードマップ)
本コンセプトの価値を早期に検証し、フィードバックを得ながら段階的に機能を拡張するため、以下の3ステップで実装を進める。

*   **Step 1: 【今回対象】MVCによるコア価値の検証**
    *   **ゴール**: CLIアプリケーションとして、ユーザーが自身の権限範囲内で「自然言語によるセマンティック検索」を体験できる最小限のシステムを構築し、本コンセプトの有効性を実証する。
    *   **実装範囲**:
        *   Google Drive クローラーの全機能。
        *   シンプルなセマンティック検索プログラムの実装。

*   **Step 2: ハイブリッド検索による精度と速度の向上**
    *   **ゴール**: 従来のキーワード検索とセマンティック検索を組み合わせたハイブリッド検索を導入。また、検索結果が中程度の場合にLLMによるリランキングを行い、検索体験を向上させる。
    *   **実装範囲**:
        *   キーワードによる高速な初期絞り込み機能の追加。
        *   検索結果件数が11件～30件程度の場合に、GPT-4o mini を用いて結果を並べ替える（リランキング）機能。

*   **Step 3: 対話型アシスタントへの進化**
    *   **ゴール**: 検索結果が多すぎるという課題を対話によって解決し、ユーザーを目的のファイルへ能動的に導くアシスタント機能を実現する。
    *   **実装範囲**:
        *   検索結果が多すぎる場合に、その傾向をAIが分析し、絞り込みのための追加質問を自動生成・提示する機能。
