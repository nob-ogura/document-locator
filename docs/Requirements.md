# 生成AIとベクトル検索を活かした Google Drive 検索システム 要件定義 (PoC)

## 1. 文書情報
- 文書名: 生成AIとベクトル検索を活かした Google Drive 検索システム 要件定義書 (PoC)
- 作成目的: `docs/Concept.md` に基づき、PoC (概念実証版) として実装すべき範囲と要件を明確化する。

## 2. システム概要
- 本システムは、Google Drive 上のドキュメントを対象に、生成AIとベクトル検索を組み合わせて「権限を遵守したセマンティック検索」を実現する。
- PoC 版では、以下の 2 つのコンポーネントを対象範囲とする。
  - Google Drive クローラー (CLI/Cron 実行想定)
  - セマンティック検索プログラム (CLI アプリケーション)
- 利用者は Google アカウントで認証された一般ユーザーであり、各ユーザーの閲覧権限を厳格に守った状態で検索結果が提示されることを要件とする。

## 3. 用語定義
- 本システム / 本サービス: 本要件定義書で対象とする Google Drive 検索システム (PoC)。
- クローラー: Google Drive 上のファイルを巡回し、メタデータや要約、Embedding を取得して DB に保存するバッチ/CLI プログラム。
- セマンティック検索: ユーザーの自然文クエリに対し、ベクトル検索や LLM を用いて意味的に関連するドキュメントを検索する方式。
- `felores/gdrive-mcp-server`: Google Drive へのアクセスや全文検索、ファイル取得を行う外部 MCP サーバー。
- Supabase: Postgres + `pgvector` 拡張を利用するマネージド DB サービス。
- Embedding: `text-embedding-3-small` で生成したベクトル表現。
- PoC: Proof of Concept。中核となる価値仮説・アーキテクチャが成立するかを検証するための最小限構成。

## 4. 対象範囲 / スコープ

### 4.1 対象とする機能
- Google Drive 内の特定フォルダ配下のファイルをクロールし、要約・キーワード・Embedding を Supabase に保存する機能。
- ユーザーの自然文クエリに対し、「閲覧権限を持つファイルのみ」を対象にしたセマンティック検索を行う CLI プログラム。
- 検索ヒット件数に応じて、キーワード絞り込み・ベクトル検索・LLM によるリランキング/絞り込みを行う分岐ロジック。

### 4.2 対象外 (非スコープ)
- Web UI / GUI の提供 (CLI のみ)。
- 画像ファイル等に対する OCR 処理。
- Drive 全体 (マイドライブ/共有ドライブ全域) のクロール。PoC では `.env` の `GOOGLE_DRIVE_TARGET_FOLDER_ID` による限定スコープのみ。
- 高可用性、マルチリージョン冗長構成等の本番運用レベルのインフラ要件。

## 5. 外部サービス / 依存コンポーネント要件

### 5.1 LLM / Embeddings
- LLM:
  - 種類: GPT-4o mini
  - 用途:
    - ファイル要約文の生成
    - 検索用キーワード抽出
    - セマンティック検索結果のリランキング/絞り込み
    - 絞り込みのための追加質問の生成
- Embeddings:
  - 種類: `text-embedding-3-small`
  - 用途: 「ファイル名 + 要約文 + キーワード」連結テキストのベクトル化

### 5.2 DB (Supabase / Postgres + pgvector)
- 拡張機能:
  - `pgvector` を有効化すること。
- テーブル構造 (例):
  - `file_id`: TEXT
  - `file_name`: TEXT
  - `summary`: TEXT
  - `keywords`: TEXT[] または JSONB
  - `embedding`: VECTOR 型
  - `updated_at`: TIMESTAMP WITH TIME ZONE
  - Start Page Token を保存するテーブル (フィールド名は実装側で決定可)。

### 5.3 Google Drive / `felores/gdrive-mcp-server`
- Google Drive API を `felores/gdrive-mcp-server` 経由で利用する。
- クローラーはサービスアカウント等の管理者権限を用いて、`GOOGLE_DRIVE_TARGET_FOLDER_ID` 配下のみをクロールする。
- 検索プログラムは、操作しているユーザー自身の認証情報を用いて `felores/gdrive-mcp-server` を呼び出す。

### 5.4 設定ファイル / 環境変数
- `.env` に最低限、以下を設定できること。
  - `GOOGLE_DRIVE_TARGET_FOLDER_ID`: クロール対象とするフォルダ ID。`,` 区切りで複数指定可能。
  - LLM / Embedding / Supabase / gdrive-mcp-server に関する接続情報各種。

## 6. セキュリティ・権限モデル要件

### 6.1 基本ポリシー
- 全ての検索は、操作ユーザーの Google アカウント認証情報を起点とする。
- ユーザーが閲覧権限を持つファイルのみが結果として表示される。

### 6.2 権限フィルタリング
- 検索プログラムは、ユーザークエリから抽出したキーワードおよび期間フィルタを用いて、`felores/gdrive-mcp-server` を検索呼び出しする。
- `felores/gdrive-mcp-server` 側の結果は、呼び出しユーザーの権限で閲覧可能なファイルのみが返却される。
- ベクトル検索を実行する場合も、`felores/gdrive-mcp-server` から取得したファイル ID 集合で Supabase 側の検索対象をフィルタリングすること。

### 6.3 対象スコープの限定
- クローラーは、`GOOGLE_DRIVE_TARGET_FOLDER_ID` に指定されたフォルダ ID 群の配下のみをクロール対象とすること。
- 指定フォルダが存在しない、またはクローラー実行主体に権限がない場合、クローラーは即座にエラー終了し、誤ったスコープでクロールを開始しないこと。

## 7. 機能要件

### 7.1 Google Drive クローラー (CLI / Cron)

#### 7.1.1 実行方式
- CLI コマンドとして実装し、手動実行および Cron 等による定期実行を想定する。

#### 7.1.2 処理フロー
- 起動時に `.env` から `GOOGLE_DRIVE_TARGET_FOLDER_ID` を読み込む。
  - `,` 区切りで指定された複数フォルダ ID を展開し、それぞれについて存在確認を行う。
  - フォルダが存在しない、または権限不足の場合はエラーを出力して処理を中断する。
- 差分検出:
  - 初回実行時:
    - Drive API の `files.list` などを用いて、対象フォルダ配下のファイルを全件取得する。
  - 2 回目以降:
    - 前回 DB に保存した Start Page Token を用いて `changes.list` を呼び出し、変更のあったファイル (新規・更新・削除) のみを取得する。
- 同期処理:
  - 新規・更新ファイル:
    - ファイルのテキストコンテンツを取得する。
    - GPT-4o mini で要約文を生成する。
    - GPT-4o mini で検索用キーワード (配列) を生成する。
    - 「ファイル名 + 要約文 + キーワード」を連結したテキストを `text-embedding-3-small` でベクトル化する。
    - Supabase のテーブルに Upsert する (存在すれば更新、なければ挿入)。
  - 削除ファイル:
    - `changes.list` から削除済みと判定されたファイル ID を取得し、Supabase 側の該当レコードを削除する。
- 状態保存:
  - 処理完了後、次回用の Start Page Token を DB に保存する。

#### 7.1.3 対象ファイル種別
- 対象:
  - Google ドキュメント
  - テキスト情報を取得可能な PDF ファイル

### 7.2 セマンティック検索プログラム (CLI)

#### 7.2.1 実行方式
- CLI コマンドとして実装する。
  - クエリはコマンドライン引数または対話入力のどちらでも受け付けられること。

#### 7.2.2 検索フロー
- 入力:
  - ユーザーから自然文クエリを受け取る。
  - クエリ内から日付指定 (期間) を抽出し、`updated_at` に対する期間フィルタとして利用可能にする。
- キーワード抽出:
  - GPT-4o mini に対し、固有名詞・プロジェクト名・ファイル形式などを優先して、検索用キーワードを最大 3 件抽出させる。
- 初期検索 (権限フィルタリングを兼ねる):
  - 抽出したキーワードおよび期間フィルタを用いて、ユーザー自身の認証情報で `felores/gdrive-mcp-server` の全文検索を行い、「ユーザーが閲覧可能なファイル」のみから候補を取得する。
- 結果件数に応じた分岐:
  - ヒット数が 101 件以上:
    - 上位結果の傾向を GPT-4o mini に分析させ、絞り込みのための追加質問文を生成し、ユーザーに提示する。
    - ユーザーの回答から追加キーワードを 1 件抽出させ、元のキーワードと組み合わせて `felores/gdrive-mcp-server` による再検索を実行する。
  - ヒット数が 31〜100 件:
    - `felores/gdrive-mcp-server` でヒットしたファイル ID 群をフィルタとして Supabase に対しベクトル検索を実行し、関連度の高い上位約 30 件に絞り込む。
  - ヒット数が 11〜30 件:
    - 取得したファイル情報をコンテキストとして GPT-4o mini に渡し、ユーザー質問意図に最も合致する 10 件を選抜させる。
  - ヒット数が 1〜10 件:
    - 取得したファイル情報を GPT-4o mini に渡し、ユーザーの質問意図への合致度に基づいてリランキングする。
  - ヒット数が 0 件:
    - ユーザーに意識させることなく、検索キーワード数を減らすなどの自動調整を行い、再検索を試みる。
    - 検索キーワードが 1 件になってもヒット数が 0 件の場合、「見つかりませんでした」と表示して終了する。
- 上記分岐ロジック適用後、必要に応じて再度同じ分岐を繰り返し、最終的にヒット数が 10 件以下となった時点で処理を終了し、結果表示フェーズに進む。

#### 7.2.3 出力
- 検索結果が 10 件以下になった場合、その時点で検索処理を終了し、画面に結果を表示する。
- 最終的にユーザーへ提示する情報:
  - ファイル名
  - 要約文
  - Google Drive へのリンク (URL)
  - 更新日時
- 出力形式はテキストベース (標準出力) とし、PoC 段階ではシンプルな一覧表示でよい。

## 8. 非機能要件

### 8.1 性能
- PoC のため厳密な SLA は設けないが、一般的なクエリに対して 30 秒以内で結果が返ることを目標とする。
- クローラーは差分取得 (`changes.list`) を用いて、フルスキャンを避け API 呼び出し回数と処理時間を削減すること。

### 8.2 信頼性
- クローラー処理中に一部のファイル取得や AI 呼び出しでエラーが発生した場合でも、可能な範囲で処理継続し、異常はログ出力すること。
- Start Page Token が不整合な場合等には、適切に全件取得や再同期などのリカバリ戦略を検討できるようにしておく (PoC では簡易実装でも可)。

### 8.3 ログ・監視 (PoC レベル)
- 少なくとも以下の情報をログとして出力すること。
  - クローラーの開始/終了時刻、処理対象フォルダ ID
  - 処理したファイル件数 (新規・更新・削除)
  - 重大なエラー内容
  - 検索クエリの概要（元のクエリ、要約文、キーワード）
- 本番運用レベルの監視/アラートはスコープ外とするが、将来的な監視連携を阻害しない構成とする。

### 8.4 セキュリティ
- 認証・認可は Google 側の仕組み (OAuth 2.0) に準拠する。
- `.env` や認証情報ファイルは Git 管理対象外とし、ローカルまたは安全なシークレットストアで管理する。
- ログには、ファイル本文や機密情報を直接出力しないこと。

## 9. 制約・前提条件
- ユーザーは Google アカウントを持ち、Drive へのアクセス権限を保有していること。
- クローラー実行環境は、対象フォルダに対する十分な権限を持つサービスアカウント/認証設定が行われていること。
- Supabase や LLM API へのネットワーク接続が可能であること。

以上。
