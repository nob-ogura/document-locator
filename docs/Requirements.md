# 生成AIとベクトル検索を活用したGoogle Drive検索システム

**要件定義書**

## 0. ドキュメント情報

*   **目的**: 本書は、提供された設計コンセプトに基づき、「生成AIとベクトル検索を活用したGoogle Drive検索システム」の最小概念実証（PoC）版に関する要件を定義し、実装および受入の基準を明確化するものである。
*   **対象読者**: プロダクトオーナー、開発エンジニア、SRE、セキュリティ管理者、PoC利用部門
*   **ステータス**: 要件確定（PoC） - Rev. 2

---

## 1. 背景・目的

### 1.1 背景
- 従来のキーワード検索では、ファイル名や本文に特定の単語が含まれていないと目的のファイルを発見することが困難だった。
- 特に、組織の知識資産が集約される共有ドライブ内の情報活用が課題となっていた。
- この課題に対し、本システムは生成AIによるコンテンツの文脈理解と、ベクトル検索による意味的な類似性に基づいた検索（セマンティック検索）を組み合わせることで、より直感的かつ高精度なファイル検索体験の実現を目指す。

### 1.2 目的
- 本プロジェクトの主目的:
  - 生成AIとベクトル検索技術を用いて**自然言語による的確なファイル検索**を可能にする
    - Google Drive上に存在する**ユーザーの閲覧権限を厳格に尊重**
  - 技術的な実現可能性と有効性を実証する
  - 実装範囲をMVPに絞り、迅速な価値検証を優先する

---

## 2. スコープ

### 2.1 インスコープ（本PoCの対象範囲）

*   **Google Drive クローラー (CLI)**: **共有ドライブを対象**とし、差分同期、テキスト抽出、AIによる要約・キーワード生成、ベクトル化、データベースへの保存（Upsert）機能。
*   **セマンティック検索プログラム (CLI)**: ユーザー権限での閲覧可能ファイル取得、クエリのベクトル化、セキュアなベクトル検索、検索結果の表示機能。
*   **対象ファイル**: **原則として共有ドライブ内の**Googleドキュメント、PDFなどテキスト抽出が可能なファイル。**個人のマイドライブは対象外とする。**
*   **データベース**: Supabase（PostgreSQL）および `pgvector` 拡張機能を利用したインデックス格納。
*   **AIモデル**: 推論に `GPT-4o mini`、ベクトル化に `text-embedding-3-small` を使用。
*   **運用**: 最小限のログ出力とジョブ実行の監視。

### 2.2 アウトオブスコープ（将来拡張候補）

*   **高度な検索機能**: ハイブリッド検索（キーワード＋ベクトル）、LLMによるリランキング機能（Step 2）。
*   **対話型インターフェース**: 検索結果に対する絞り込み支援など、対話型アシスタント機能（Step 3）。
*   **UI**: Webアプリケーションなどのグラフィカル・ユーザー・インターフェース。
*   **対象ファイルの拡張**: 画像ファイル内の文字列抽出（OCR）、個人のマイドライブにあるファイルのインデックス化。

---

## 3. システム構成

| 分類                 | 利用サービス・技術     | 役割                                                       |
| :------------------- | :--------------------- | :--------------------------------------------------------- |
| **LLM / Embeddings** | GPT-4o mini            | ファイルの要約文、キーワードの生成                         |
|                      | text-embedding-3-small | テキストデータ（ファイル名、要約、キーワード）のベクトル化 |
| **データベース**     | Supabase (PostgreSQL)  | ファイルのメタデータ、ベクトル情報の格納・検索             |
|                      | └ `pgvector` 拡張機能  | 高速なベクトル検索の実行                                   |
| **連携サービス**     | Google Drive API       | ファイルの変更履歴取得、コンテンツ抽出、権限情報の参照     |
| **開発言語**         | Python 3.10以上        | アプリケーション実装                                       |

---

## 4. 成果目標 / KPI（PoC受入基準）

| ID        | 指標                 | 目標値                                                                                                               |
| :-------- | :------------------- | :------------------------------------------------------------------------------------------------------------------- |
| **KPI-1** | **権限厳守**         | 他ユーザー専用ファイルのメタデータ（名称・要約）露出が0件であること（テストケース100%合格）。                        |
| **KPI-2** | **検索有用性**       | 代表20クエリに対し、検索結果Top5に人手評価で関連度3/5以上のファイルが70%以上含まれること。                           |
| **KPI-3** | **インデックス鮮度** | Google Driveの**共有ドライブ**でのファイル変更が検知されてからDBに反映されるまでの時間が**平均15分以内**であること。 |

---

## 5. 前提・制約

*   マルチユーザー環境であるGoogle Workspaceを前提とする。
*   クローラーは**組織内の共有ドライブ**を横断的にクロールするため、**管理者権限を持つサービスアカウント**で実行するが、検索は**必ず個々のユーザー権限**でフィルタリングする。
*   APIコストを考慮し、PoC期間中は指定の軽量モデル（GPT-4o mini）を使用する。

---

## 6. 機能要件 (FR)

### 6.1 Google Drive クローラー (CLI)

| ID          | 機能名                 | 要件                                                                                                                                              | 受入基準                                                                                                               |
| :---------- | :--------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------ | :--------------------------------------------------------------------------------------------------------------------- |
| **FR-C-01** | **差分変更検出**       | Google Drive APIの`drives.list`で組織内の全共有ドライブを特定し、**共有ドライブごとに**`changes.list`とStart Page Tokenを利用して差分を検出する。 | テスト用の共有ドライブでのファイル操作（作成、更新、削除）が、次回のクローラー実行時に正しく差分として検出されること。 |
| **FR-C-02** | **コンテンツ抽出**     | Googleドキュメント、PDF等の対象ファイルからテキストを抽出する。抽出失敗時はスキップし、ログに記録する。                                           | 代表的な形式のファイル50件で、テキスト抽出成功率が98%以上であること。                                                  |
| **FR-C-03** | **AIメタデータ生成**   | 抽出したテキストをGPT-4o miniに入力し、「ファイル要約文（200-300字程度）」と「検索用キーワード（5-10個程度）」を生成する。                        | 人手による評価で、生成された要約文の妥当性スコアが平均3/5以上であること。                                              |
| **FR-C-04** | **ベクトルデータ生成** | 「ファイル名」「要約文」「キーワード」を結合したテキストを、text-embedding-3-smallを用いてベクトル（Embedding）に変換する。                       | 生成されたベクトルデータがDBに正しく保存され、検索に利用可能な形式であること。                                         |
| **FR-C-05** | **インデックス同期**   | 新規/更新ファイルはDBにUpsertし、削除ファイルはDBから対応レコードを削除する。                                                                     | ファイルのライフサイクル（作成→更新→削除）がDBに正しく反映されること。                                                 |
| **FR-C-06** | **状態保存**           | 次回の差分検出に利用するため、処理完了後に**共有ドライブごとに**新しいStart Page TokenをDBの`crawler_state`テーブルに永続化する。                 | クローラー実行後、各共有ドライブに対応するStart Page Tokenが更新されていること。                                       |

### 6.2 セマンティック検索プログラム (CLI)

| ID          | 機能名                 | 要件                                                                                                                     | 受入基準                                                                                      |
| :---------- | :--------------------- | :----------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------- |
| **FR-S-01** | **検索クエリ受付**     | コマンドライン引数または対話形式で、ユーザーから自然言語の検索クエリを受け付ける。                                       | 3文字以上500文字以下のクエリが正常に受け付けられること。                                      |
| **FR-S-02** | **権限フィルタリング** | **最優先処理として**、ユーザー自身の認証情報でGoogle Drive APIを呼び出し、閲覧権限を持つ全ファイルIDのリストを取得する。 | 権限テストにおいて、他者専用のファイルIDがこのリストに含まれないこと。                        |
| **FR-S-03** | **セマンティック検索** | 1. クエリをベクトル化する。<br>2. **FR-S-02で取得したIDリストでDBを絞り込んだ上で**、ベクトル類似度検索を実行する。      | 類似度スコア（例: 0.7以上）でフィルタリングされ、類似度の降順で結果が返されること。           |
| **FR-S-04** | **結果表示**           | 検索結果を類似度の高い順に一覧表示する。表示項目は「ファイル名」「要約文」「Google Driveリンク」「類似度スコア」とする。 | 指定された4項目がコンソールに正しく出力されること。結果がない場合はメッセージを表示すること。 |

---

## 7. 非機能要件 (NFR)

*   **NFR-SEC-01（情報漏洩防止）**: 権限フィルタを適用しないデータベース検索は**技術的に実装を禁止**する。すべての検索パスで権限チェックが強制される設計とすること。
*   **NFR-SEC-02（データ保護）**: APIキー、認証トークン等の資格情報は環境変数またはシークレット管理サービスで安全に管理し、コードにハードコードしない。通信は全てTLSで暗号化する。
*   **NFR-REL-01（耐障害性）**: クローラーはAPIエラー発生時に指数バックオフ付きのリトライ処理（最大3回）を行い、単一ファイルの処理失敗で全体が停止しない設計とする。
*   **NFR-OBS-01（可観測性）**: クローラーと検索CLIの実行ログ、エラーログ、主要メトリクス（処理件数、レイテンシ、失敗率）を標準出力およびログファイルに出力する。
*   **NFR-COST-01（コスト管理）**: APIコール回数やトークン消費量をログに出力し、PoCにかかるコストを可視化できるようにする。

---

## 8. データ要件 / スキーマ

*   **データベース**: Supabase (PostgreSQL)
*   **必須拡張機能**: `pgvector`

### 8.1 テーブル: `file_index`

| カラム名        | データ型                   | NULL許可 | 説明                                                 |
| :-------------- | :------------------------- | :------- | :--------------------------------------------------- |
| `file_id`       | `TEXT`                     | NO       | **主キー**、Google DriveのファイルID                 |
| `file_name`     | `TEXT`                     | NO       | ファイル名                                           |
| `summary`       | `TEXT`                     | YES      | AIが生成したファイル要約文                           |
| `keywords`      | `TEXT[]`                   | YES      | AIが生成した検索用キーワード配列                     |
| `embedding`     | `VECTOR(1536)`             | YES      | 埋め込みベクトル（`text-embedding-3-small`の次元数） |
| `updated_at`    | `TIMESTAMP WITH TIME ZONE` | NO       | 最終更新日時                                         |
| `last_modifier` | `TEXT`                     | NO       | 最終更新ユーザー名                                   |

*   **インデックス**:
    *   `file_id` (PRIMARY KEY)
    *   `embedding` (HNSW or IVFFlat) ※ベクトル検索用

### 8.2 テーブル: `crawler_state`

| カラム名           | データ型                   | NULL許可 | 説明                                           |
| :----------------- | :------------------------- | :------- | :--------------------------------------------- |
| `drive_id`         | `TEXT`                     | NO       | **主キー**、Google Driveの共有ドライブID       |
| `start_page_token` | `TEXT`                     | YES      | その共有ドライブ用の次回実行用Start Page Token |
| `last_run_at`      | `TIMESTAMP WITH TIME ZONE` | NO       | 最終実行日時                                   |

---

## 9. テスト計画（抜粋）

*   **権限テスト**: 複数ユーザー（A, B）と専用/共有ファイルを用意し、Aの検索結果にBの専用ファイルが含まれないこと、逆もまた然りであることを確認する（**KPI-1**）。
*   **差分同期テスト**: テスト用の**共有ドライブ**でファイルの「作成」「更新」「削除」を行い、クローラー実行後にDBの状態が正しく同期されていることを確認する。

---

## 10. ロードマップ

*   **Step 1: 【本要件の対象】MVPによるコア価値の検証**
    *   **ゴール**: CLIベースで、権限を遵守したセキュアなセマンティック検索が有効であることを実証する。
*   **Step 2: ハイブリッド検索による精度と速度の向上**
    *   **ゴール**: キーワード検索との組み合わせによる検索体験向上と、LLMによるリランキング機能の追加。
*   **Step 3: 対話型アシスタントへの進化**
    *   **ゴール**: 検索結果が多すぎる場合に、AIが対話形式で絞り込みを支援する機能の実現。

---

## 11. 付録

### 11.1 CLI仕様（案）

**クローラー CLI**
```bash
# 差分実行（通常）
gdrive-indexer crawl --mode=delta

# 初回実行
gdrive-indexer crawl --mode=full
```

**検索 CLI**
```bash
gdrive-search query "第3四半期の事業計画に関する報告書" --topk=5
```

### 11.2 pgvector検索（疑似SQL）

```sql
-- :query_vector ... 検索クエリをベクトル化したもの
-- :visible_file_ids ... ユーザーが閲覧可能なファイルIDの配列
-- :top_k ... 取得したい件数

SELECT
  file_id,
  file_name,
  summary,
  embedding <-> :query_vector AS similarity_score
FROM
  file_index
WHERE
  file_id = ANY(:visible_file_ids) -- ★最重要: 必ず権限で絞り込む
ORDER BY
  similarity_score
LIMIT
  :top_k;
```
> **注意**: `WHERE`句による`file_id`での事前フィルタリングは、セキュリティの根幹であり、省略を許容しない設計とする。