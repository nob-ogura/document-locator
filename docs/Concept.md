# 生成AIとベクトル検索を活かしたGoogle Drive検索システム (PoC: 概念実証版)

## はじめに
本ドキュメントは、「生成AIとベクトル検索を活用した次世代のGoogle Drive検索システム」の**概念実証（Proof of Concept）**を目的とする。

コンセプトの核となる価値（ヒット件数に応じたハイブリッド検索）を迅速に検証するため、実装範囲を**最小限の実行可能な構成（MVP: Minimum Viable Product）**に絞り込み、過剰な実装を避けた計画を定義する。

## セキュリティと権限に関する基本設計
* 本システムは、シングルユーザー環境での利用を前提とする。
* システム設計の核として、以下の権限モデルを採用する。
  *   **検索の起点**: ユーザーがCLIから実行する検索処理は、操作しているユーザー自身のGoogleアカウント認証情報を用いて開始される。
  *   **クロールの起点**: Google Drive クローラーも、検索処理と同一のユーザーのGoogleアカウント認証情報のみを用いて実行し、サービスアカウントなど別主体によるクロールは本PoCの想定外とする。
  *   **対象スコープの固定化**: PoCのクロール/検索対象は `.env` に記述した `GOOGLE_DRIVE_TARGET_FOLDER_IDS` で指定した各フォルダと、そのサブフォルダを再帰的にたどった配下のフォルダ／ファイルとする。

## 外部サービス構成
1.  **LLM / Embeddings**:
    *   推論用: GPT-4o mini
    *   ベクトル化用: text-embedding-3-small
2.  **DB**: Supabase
    *   拡張機能 `pgvector` を有効化
    * テーブル名: `drive_file_index`
      * カラム:
        * `file_id`: TEXT, PK
        * `file_name`: TEXT, NOT NULL
        * `summary`: TEXT, NOT NULL
        * `keywords`: TEXT[] (キーワード配列)
        * `embedding`: VECTOR, NOT NULL
        * `drive_modified_at`: TIMESTAMPTZ, NOT NULL (Google Drive の `modifiedTime` を保持)
        * `mime_type`: TEXT, NOT NULL
    * テーブル名: `drive_sync_state`
      * カラム:
        * `id`: TEXT, PK (例: `global` などシステム全体で1件のみ)
        * `drive_modified_at`: TIMESTAMPTZ, NOT NULL (クロールしたファイル群の最大 `modifiedTime` を保持)


## 実装内容

### 1. Google Drive クローラー (CLI / Cron)
Google Driveを定期的に巡回し、検索用インデックス（DB）を構築・更新する、システムの土台となる機能。

*   **プロセス**:
    0.  **ターゲットフォルダの解決**:
        *   `.env` の `GOOGLE_DRIVE_TARGET_FOLDER_IDS` を読み込み、Google Drive API で存在確認を行う。
            *   区切り文字 `,` で複数のターゲットフォルダを設定できる。
        *   フォルダが見つからない場合や権限が不足している場合は即座に失敗させ、誤ったスコープでクロールを開始しない。
    1.  **変更リストの取得（差分検出の効率化）**:
        *   初回のみ: `GOOGLE_DRIVE_TARGET_FOLDER_IDS` で指定した各フォルダを起点に、そのサブフォルダを再帰的にたどりながら `files.list` を用いて配下の全ファイルを取得し、各ファイルの `modifiedTime` を `drive_file_index.drive_modified_at` として保存する。
        *   初回以降: `drive_sync_state.drive_modified_at` 以降に更新されたファイルのみを対象に、同じくターゲットフォルダ配下（サブフォルダを含む階層全体）を再帰的にたどりながら `files.list` で取得し、差分クロールを行う。
            *   クエリ時点で、`GOOGLE_DRIVE_TARGET_FOLDER_IDS` で指定したフォルダと、そのサブフォルダを再帰的に列挙した範囲にスコープを限定する。
            *   Google Drive の仕様上、`modifiedTime` が変化しない削除・移動・権限変更はこの差分検出では拾えない。
        *   差分検出では「新規作成・更新」のみを追跡し、削除・移動・権限変更への追従は行わない。
    2.  **同期処理**:
        *   **新規・更新ファイル**: リスト内の新規・更新ファイルのうち、テキストコンテンツを取得可能なもののみを対象に、後述のAI処理を実行する。
        *   **削除・移動・権限変更**:
            *   `modifiedTime` ベースの差分検出では、Drive 上の削除・移動・権限変更を完全には検知できない。
            *   そのため PoC では、`drive_file_index` 上に「論理的には削除済み／移動済み／閲覧不可なファイル」のレコードが残り続ける「インデックスの汚れ」を仕様として許容する。
            *   製品化を見据えた将来バージョンでは、Drive の変更履歴 API や定期的なフルスキャンなどにより、インデックスのクリーンアップを行う想定とする。
    3.  **AI処理**:
        *   対象ファイルのテキストコンテンツを抽出。 *(注: GoogleドキュメントやPDF等のテキスト情報を主対象とし、画像ファイル内の文字列抽出（OCR）は今回の対象外とする。)*
        *   画像ファイルやその他バイナリファイル（例: `.jpg`, `.png`, `.gif`, `.zip` 等）はインデックス対象外とし、`drive_file_index` にレコードを作成しない（＝検索結果にも表示されない）。
        *   GPT-4o mini で「ファイル要約文」と「検索用キーワード」を生成。
        *   text-embedding-3-small で「要約文 + キーワード + ファイル名」を結合したテキストから「ベクトル（Embedding）」を生成。
    4.  **保存と状態更新**:
        *   AI処理後のすべての情報を Supabase の `drive_file_index` テーブルに Upsert（挿入・更新）する。
        *   次回のクロールに備え、取得したファイル群の最大 `modifiedTime` で `drive_sync_state.drive_modified_at` を更新する。

### 2. セマンティック検索プログラム (CLI)
CLIアプリケーションとして実装する。概念実証（PoC）の段階では、中核機能である「ヒット件数に応じたハイブリッド検索」が有効であることを証明するシンプルな構成とする。

*   **検索フロー**:
    1.  **クエリ解析 & Embedding生成**:
        *   コマンドライン引数、または対話形式でユーザーの自然文クエリを受け付ける。
        *   クエリから日付指定があれば抽出し、期間フィルタ (`modifiedTime`) を用意する。
        *   クエリからファイル種別指定があれば抽出し、MIMEタイプフィルタ (`mimeType`) を用意する
            （現状はテキスト取得可能な MIME のみ対象）。
        *   GPT-4o mini に固有名詞やプロジェクト名を優先するプロンプトでキーワードを1〜5件抽出し、
            「ユーザー入力＋抽出キーワード」を text-embedding-3-small でベクトル化する。
        *   類似度しきい値の初期値は 0.70、上限取得件数は 80 件とする。

    2.  **ベクトル検索 (Supabase / pgvector)**:
        *   `drive_file_index.embedding` に対し、上記ベクトルで類似検索を実行する。
        *   期間・MIME フィルタは Supabase 側の SQL で同時適用し、類似度順にソートする。
        *   取得結果に `similarity` を含め、しきい値以上の件数を「ヒット件数」と定義する。

    3.  **ヒット件数／類似度ベースの分岐ロジック**:
        *   **ヒット件数が 50件以上 または 最上位類似度 < 0.75 (過大・曖昧ケース)**:
            *   LLM で「追加の絞り込み質問」を1件生成し、ユーザー入力を受け付ける。
            *   追加キーワードやフィルタを反映して再Embeddingし、類似度しきい値を 0.82 に引き上げて
                再検索する（ループ可）。
        *   **ヒット件数が 10件 〜 49件 (中規模ケース)**:
            *   上位 20 件を保持し、類似度 0.75 未満は除外する。
            *   必要に応じて LLM によるクエリリライトを行い、同一フィルタで再Embedding・再検索する。
        *   **ヒット件数が 2件 〜 9件 (LLMによるリランキング)**:
            *   取得したファイル情報をコンテキストとして GPT-4o mini に渡し、
                「ユーザー意図への適合度」でソートする。
            *   ソート後のファイル名・要約文・Google Driveリンクを標準出力に一覧表示する。
        *   **ヒット件数が 1件 (そのまま表示)**:
            *   当該ファイルのファイル名・要約文・Google Driveリンクを表示する。
        *   **ヒット件数が 0件 (広げる)**:
            *   類似度しきい値を 0.60 まで緩和したうえで再検索し、併せて LLM による
                キーワード削減を試みる。
            *   再検索でも 0 件なら「見つかりませんでした」と出力して終了する。
        *   上記いずれかで結果を表示したら終了し、それ以外は再Embedding→再検索を繰り返す。

    4.  **Drive API の利用タイミング**:
        *   検索の起点では Drive API の全文検索を行わない。
        *   ベクトル検索で得た `file_id` についてのみ、必要に応じて以下の目的で Drive API を呼ぶ。
            *   存在確認・権限確認（404 や 403 は結果から除外し、インデックス汚れとしてログ出力）。
            *   最新の `modifiedTime` や MIME を取得し、差異があればインデックス更新キューに積む。
            *   ターゲットフォルダ範囲（`GOOGLE_DRIVE_TARGET_FOLDER_IDS`）内であることを検証する。

    5.  **ベクトル検索先行のデメリット（明示的に許容）**:
        *   新規ファイルや未クロールのファイルはインデックスに載るまで検索に出ない。
        *   権限変更・削除・移動はクロールで検知するまで結果に残る可能性がある。
        *   Drive API での存在確認は結果候補に限定するため、検知までの遅延を前提とする。
