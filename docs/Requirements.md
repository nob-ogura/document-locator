# 生成AIとベクトル検索を活かしたGoogle Drive検索システム 要件定義（PoC）

## 1. 文書の目的と位置づけ

- 本書は、「生成AIとベクトル検索を活用した次世代のGoogle Drive検索システム」PoC（概念実証版）の要件定義を示す。
- PoC の目的は、ヒット件数に応じて検索手段を切り替える「ハイブリッド検索」の有効性を、最小限の実装（MVP）で検証することとする。
- 本書の内容は、実装・テスト・運用設計のインプットとして利用される。

## 2. システム概要

### 2.1 システム名

- 名称：Google Drive 検索 CLI（以降「本システム」）

### 2.2 対象範囲

- 対象：単一ユーザーが自身の Google アカウント配下の Google Drive を検索するための CLI ツールと、そのためのインデックス作成基盤。
- 対象外：
  - 複数ユーザー／組織アカウントを跨いだ利用
  - Web UI や API サーバーなど、CLI 以外のフロントエンド
  - 本番運用レベルの監視・冗長構成・SLA 設定

### 2.3 想定利用者

- 自身の Google アカウントで Google Drive を日常的に使用している技術ユーザー。
- ターミナル上で CLI コマンドを実行できるユーザー。

### 2.4 用語定義（抜粋）

- PoC：概念実証。ビジネス価値や技術的成立性を検証することを主目的とする。
- MVP：Minimum Viable Product。価値検証に必要な最小限の機能セット。
- ハイブリッド検索：Google Drive API によるキーワード検索と、ベクトル検索＋LLM を組み合わせて、ヒット件数に応じて処理を切り替える検索方式。
- ヒット件数：Google Drive API の検索結果から得られた `file_id` と、Supabase 上の `drive_file_index` テーブルに登録済みの `file_id` との積集合の件数。

## 3. 前提条件・非対象

### 3.1 セキュリティと権限モデル

- シングルユーザー環境を前提とし、検索を実行するユーザーと Google Drive クローラーは同一の Google アカウント認証情報を用いる。
- サービスアカウントなど、ユーザー本人以外の主体による Drive クローリングは本 PoC の対象外とする。
- クロール／検索対象は `.env` で指定する `GOOGLE_DRIVE_TARGET_FOLDER_IDS` に含まれる各フォルダと、そのサブフォルダ配下のファイルに限定する。

### 3.2 外部サービス

- Google Drive API
  - ファイル・フォルダの検索およびメタデータ取得に使用する。
- LLM / Embeddings（OpenAI）
  - 推論用モデル：GPT-4o mini
  - ベクトル化モデル：text-embedding-3-small
- DB（Supabase）
  - PostgreSQL＋ `pgvector` 拡張機能を利用し、インデックス情報を保存する。

### 3.3 対象ファイル種別と非対象

- インデックス対象：
  - Google ドキュメント、PDF など、Google Drive API を通じてテキストコンテンツを取得可能なファイル。
- 非対象：
  - 画像（例：`.jpg`, `.png`, `.gif`）やその他バイナリ（例：`.zip`）はインデックス対象外とし、検索結果にも表示しない。
  - 画像内テキストを対象とした OCR 処理は行わない。

### 3.4 差分検出と制約

- 差分検出はファイルの `modifiedTime` を基準とし、「新規作成・更新」のみを追跡対象とする。
- Drive 上での削除・移動・権限変更は `modifiedTime` の変化に依存しないため、本 PoC では完全には検知しない。
- このため、 `drive_file_index` 上に「論理的には削除済み／移動済み／閲覧不可」となったファイルのレコードが残り続けること（インデックスの汚れ）を仕様として許容する。
- `.env` 内のクロール対象条件（例：`GOOGLE_DRIVE_TARGET_FOLDER_IDS`）が変更された場合は、差分検出による更新は行わず、次回クロール実行時にフルスキャンからやり直すものとする。

### 3.5 実行環境

- 本 PoC で公式にサポートする OS は macOS とする。
- 上記以外の OS（例：Linux、Windows）は動作検証の対象外とする。

## 4. 機能要件（全体）

### 4.1 機能一覧

1. Google Drive クローラー（CLI / Cron 実行）
2. セマンティック検索 CLI
3. LLM を用いたキーワード抽出・追加質問生成・リランキング
4. ベクトル検索（Supabase＋pgvector）

### 4.2 共通要件

- `.env` ファイルに設定された各種環境変数（API キー、DB 接続情報、`GOOGLE_DRIVE_TARGET_FOLDER_IDS` 等）を利用して動作する。
- LLM にコンテキストとして渡すファイル情報は、ユーザーの Google Drive 検索結果で得られた `file_id` と Supabase の `drive_file_index` に登録された `file_id` の積集合に限定する。

## 5. 機能要件：Google Drive クローラー

### 5.1 概要

- Google Drive を定期または手動で巡回し、検索用インデックス（DB）を構築・更新する CLI プログラムを提供する。
- Cron から実行できることを前提とする。

### 5.2 入力・出力

- 入力：
  - `.env` ファイルに定義された `GOOGLE_DRIVE_TARGET_FOLDER_IDS`（カンマ区切りで複数指定可能）。
  - Supabase への接続情報。
  - OpenAI API キー。
- 出力：
  - Supabase 内の `drive_file_index` テーブルへのインデックスレコード（Upsert）。
  - Supabase 内の `drive_sync_state` テーブルへの同期状態レコード更新。

### 5.3 処理フロー

1. ターゲットフォルダの解決
   - `GOOGLE_DRIVE_TARGET_FOLDER_IDS` で指定された各フォルダ ID について、Google Drive API で存在確認を行う。
   - フォルダが存在しない、または権限不足の場合は処理を即時失敗させ、クロールを開始しない。
2. 初回クロール（フルスキャン）
   - ターゲットフォルダを起点としてサブフォルダを再帰的にたどり、`files.list` により配下の全ファイルを取得する。
   - テキスト取得可能なファイルについて、後述の AI 処理を行い、`drive_file_index` に保存する。
   - 取得したファイル群の `modifiedTime` の最大値を `drive_sync_state.drive_modified_at` に保存する。
   - 前回クロール実行時から `GOOGLE_DRIVE_TARGET_FOLDER_IDS` 等のクロール対象条件が変更されている場合も、本フローを再度実行し、フルスキャンからやり直す。
3. 差分クロール
   - 2 回目以降は、`drive_sync_state.drive_modified_at` 以降に更新されたファイルを対象に、同様にターゲットフォルダ配下を再帰的に検索する。
   - 差分対象はテキスト取得可能なファイルの新規作成・更新に限定する。
4. AI 処理
   - 対象ファイルのテキストコンテンツを取得する。
   - GPT-4o mini を用いて、以下を生成する。
     - ファイル要約文（`summary`）
    - 検索用キーワード（`keywords`、1〜5件程度のキーワードを想定）
   - 「要約文＋キーワード＋ファイル名」を連結したテキストを text-embedding-3-small に入力し、ベクトル（`embedding`）を生成する。
   - 要約文（`summary`）は、設定ファイルに定義された最大文字数 M 文字以内となるように生成・切り詰める。
5. インデックス保存と同期状態更新
   - 取得した情報を `drive_file_index` テーブルに Upsert する。
   - 対象ファイル群の `modifiedTime` の最大値で `drive_sync_state.drive_modified_at` を更新する。

### 5.4 DB テーブル要件

- `drive_file_index` テーブル
  - カラム：
    - `file_id`: TEXT, PK
    - `file_name`: TEXT, NOT NULL
    - `summary`: TEXT, NOT NULL
    - `keywords`: TEXT[] （キーワード配列）
    - `embedding`: VECTOR, NOT NULL
    - `drive_modified_at`: TIMESTAMPTZ, NOT NULL（Google Drive の `modifiedTime`）
    - `mime_type`: TEXT, NOT NULL
- `drive_sync_state` テーブル
  - カラム：
    - `id`: TEXT, PK（`global` とし、システム全体で 1 件のみ）
    - `drive_modified_at`: TIMESTAMPTZ, NOT NULL（クロール済みファイル群の最大 `modifiedTime`）

## 6. 機能要件：セマンティック検索 CLI

### 6.1 概要

- ユーザーの自然文クエリを受け取り、ヒット件数に応じて検索方式を切り替える CLI アプリケーションを提供する。
- 中核機能は、以下 3 要素の組み合わせによるハイブリッド検索とする。
  - Google Drive API による全文検索
  - ベクトル検索（`drive_file_index.embedding`）
  - LLM によるキーワード抽出・質問生成・リランキング

### 6.2 入力・出力

- 入力：
  - コマンドライン引数または対話入力で受け取る自然文クエリ。
    - クエリに日付・期間指定、ファイル種別指定が含まれる場合は検索オプションとして利用する。
- 出力：
  - 条件に合致したファイルの一覧（ヒット件数 2〜10 件の場合）。
    - 表示項目：ファイル名、要約文、Google Drive リンク。
  - ヒット件数が 1 件の場合は、該当ファイルのみ表示する。
  - ヒット件数が 0 件かつ検索キーワードが 1 件になった場合、「見つかりませんでした」と表示して終了する。

### 6.3 検索フロー

1. クエリ解析
   - 自然文クエリから、以下の情報を抽出する。
     - 期間指定（あれば）：`modifiedTime` によるフィルタ。
     - ファイル種別指定（あれば）：`mimeType` によるフィルタ。
  - GPT-4o mini に対し、固有名詞、プロジェクト名、ファイル形式などを優先するよう指示したプロンプトを用いて、検索キーワードを 1〜5 件抽出する。
2. 初期検索（Google Drive）
   - 抽出した検索キーワードと、期間・MIME フィルタを組み合わせて、Google Drive API による全文検索を実行する。
   - 検索対象は `GOOGLE_DRIVE_TARGET_FOLDER_IDS` で指定したフォルダとそのサブフォルダ配下に限定する。
3. ヒット件数の算出
   - Google Drive 検索結果から得られた `file_id` 集合と、Supabase 上の `drive_file_index` に存在する `file_id` 集合との積集合を取得し、その件数を「ヒット件数」とする。

### 6.4 ヒット件数に応じた分岐ロジック

1. ヒット件数が 101 件以上（対話によるキーワード絞り込み）
   - ヒットした上位のファイル情報（要約＋メタデータ）をコンテキストとして GPT-4o mini に渡し、絞り込みのための「追加の質問」を生成する。
   - CLI 上でユーザーに追加質問を表示し、キーボード入力で回答を受け付ける。
   - 回答テキストを GPT-4o mini に渡し、
     - 絞り込みに有効な追加キーワードを 1 件抽出する、または
     - 期間・MIME などの追加フィルタ条件を抽出する。
   - 元のキーワードと追加キーワード／追加フィルタを組み合わせて、再度 Google Drive API で全文検索を行い、再びヒット件数に応じた分岐処理を行う。
2. ヒット件数が 11〜100 件（ベクトル検索）
   - 「ユーザーのクエリ＋抽出キーワード」を text-embedding-3-small でベクトル化する。
   - Supabase 上の `drive_file_index.embedding` に対して類似検索を行う。
     - 検索対象は、Google Drive 検索結果と `drive_file_index` の積集合に含まれるファイルに限定する。
   - 類似度上位の候補から最大 10 件を取得する。
   - この 10 件の候補集合の件数を、次のループにおける「ヒット件数」として扱う（2〜10 件の想定）。
     - 候補集合の件数に応じて、6.4.3〜6.4.5 の分岐処理に進む。
3. ヒット件数が 2〜10 件（LLM によるリランキング）
   - 候補ファイルの要約・メタデータをコンテキストとして GPT-4o mini に渡し、「ユーザーの質問意図に合致する順」にソートさせる。
   - ソート結果に従って、ファイル名・要約文・Google Drive リンクを CLI に一覧表示する。
   - 処理を終了する。
4. ヒット件数が 1 件（そのまま表示）
   - 該当ファイル 1 件のファイル名・要約文・Google Drive リンクを表示する。
   - 処理を終了する。
5. ヒット件数が 0 件（キーワードの自動調整）
   - GPT-4o mini に対し、検索キーワード数を減らす、またはフィルタ条件（期間・MIME）を緩和するよう指示し、新たな検索条件を生成させる。
   - 新たな検索条件で再度 Google Drive API による検索を行い、再びヒット件数に応じた分岐処理を行う。
   - 検索キーワードが 1 件になってもヒット件数が 0 件の場合、「見つかりませんでした」と表示して処理を終了する。
6. 繰り返し条件
   - 上記のうち、
     - 「ヒット件数が 1〜10 件」の場合、または
     - 「検索キーワードが 1 件になってもヒット件数が 0 件の場合」
     は処理を終了する。
   - それ以外の場合: 更新された検索条件を用いて 6.3 以降の処理を繰り返す。
     - ただし、このループの実行回数は最大 N 回までとし、N は `.env` に定義された設定値（例：`SEARCH_MAX_LOOP_COUNT`）とする。
     - N 回に達した時点でのヒット件数が 1〜10 件または 0 件の場合:
       - 6.4.3〜6.4.5 の分岐に従って処理を行い、終了する。
     - N 回に達した時点でもヒット件数が 11 件以上（10 件以下に絞り込めていない状態）の場合:
       - 「ループ回数の上限（N 回）に到達したが 10 件以下に絞り込めませんでした。クエリを見直して再実行してください。」という趣旨のメッセージを表示して終了する。

## 7. 非機能要件（PoC 前提）

- PoC／MVP フェーズであるため、本番運用レベルの可用性・性能・スケーラビリティに関する数値目標は定めない。
- インデックス内容は Google Drive の状態と完全には一致しない可能性がある（削除／移動／権限変更の反映遅延を許容する）。
- 検索品質（関連度）は LLM およびベクトル検索の特性に依存し、すべてのクエリに対して最適な結果が得られることは保証しない。

## 8. 運用・設定要件

- `.env` ファイルに以下の項目を定義できること。
  - Google Drive API 関連設定（認証情報・`GOOGLE_DRIVE_TARGET_FOLDER_IDS` 等）
  - Supabase 接続情報
  - OpenAI API キー
  - 要約文の最大文字数 M（例：`SUMMARY_MAX_LENGTH`）など、AI 処理に関するパラメータ
  - 検索フローの最大ループ回数 N（例：`SEARCH_MAX_LOOP_COUNT`）
- クローラーは macOS 上で OS のタスクスケジューラ（cron）から定期実行できること。
- システムは、環境変数や設定ファイルの変更により、設定を切り替えられる構成とする。このうちクロール対象に関わる設定（例：`GOOGLE_DRIVE_TARGET_FOLDER_IDS`）を変更した場合は、次回クロール時にフルスキャンが実行されること。
