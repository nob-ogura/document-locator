# 生成AIとベクトル検索を活かした Google Drive 検索システム 実装計画 (PoC)

## 1. 前提とゴール

- 対象: `docs/Requirements.md` で定義された PoC 版 (クローラー CLI / セマンティック検索 CLI)。
- ゴール:
  - Google Drive 特定フォルダ配下のファイルをクロールし、Supabase (Postgres + pgvector) に要約・キーワード・Embedding を保存できること。
  - ユーザーの権限を厳格に守りながら、自然文クエリに対するセマンティック検索を CLI から実行できること。
  - 要件定義に記載された分岐ロジックに従って検索ヒット件数に応じた処理が行われること。
- 実装言語 / フレームワーク:
  - 言語: TypeScript
  - 実行環境: Node.js (LTS 推奨)
  - 想定ライブラリ:
    - CLI フレームワーク: `commander` または同等の CLI ライブラリ
    - 環境変数ローダー: `dotenv`
    - HTTP クライアント: `fetch` (Node.js 組み込み) または `axios`
    - Supabase アクセス: `@supabase/supabase-js` または Postgres 用クライアント (`pg` など)
  - ビルド/ツールチェーン:
    - パッケージマネージャー: `pnpm` または `npm`
    - ビルド: `ts-node` / `tsup` / `esbuild` 等を用いたシンプルな CLI バンドルを想定

## 2. 全体アーキテクチャ設計

### 2.1 コンポーネント整理

- クローラー CLI
  - 役割: Google Drive の指定フォルダ配下を巡回し、メタデータ・要約・キーワード・Embedding を生成し Supabase に保存。
  - 入力: `.env` に定義した `GOOGLE_DRIVE_TARGET_FOLDER_ID`、LLM / Embedding / Supabase / `felores/gdrive-mcp-server` 接続情報。
  - 出力: Supabase DB のレコード更新、ログ出力。
- セマンティック検索 CLI
  - 役割: ユーザー自然文クエリから権限を考慮した検索を実施し、結果を標準出力に表示。
  - 入力: ユーザークエリ、ユーザーの Google 認証情報。
  - 出力: ファイル名・要約・URL・更新日時の一覧。
- 共通モジュール
  - 設定読み込み (`.env`)
  - LLM / Embedding API クライアント
  - Supabase / Postgres アクセスレイヤ
  - `felores/gdrive-mcp-server` クライアント
  - ロギングユーティリティ

### 2.2 データモデルと DB 設計

- `files` テーブル (想定)
  - `file_id`: TEXT (PK 相当)
  - `file_name`: TEXT
  - `summary`: TEXT
  - `keywords`: TEXT[]
  - `embedding`: VECTOR
  - `updated_at`: TIMESTAMPTZ
  - `created_at`: TIMESTAMPTZ
- `crawler_state` テーブル (Start Page Token 保存用・差分取得用)
  - `id`: TEXT (固定キー)
  - `start_page_token`: TEXT
  - `updated_at`: TIMESTAMPTZ
- 実装タスク:
  - Supabase 上で `pgvector` 拡張の有効化。
  - 上記テーブルを作成するマイグレーションスクリプトの準備。
  - DB 接続情報を `.env` から読み込む実装。

## 3. フェーズ別実装計画

### フェーズ 1: 開発環境と基盤コードの整備 (P0)

- プロジェクト初期化
  - CLI アプリケーション構成の雛形作成 (エントリーポイント、サブコマンド等)。
  - `docs/Concept.md` / `docs/Requirements.md` に合わせた README 簡易追記 (使用方法の骨子)。
- 設定・環境変数管理
  - `.env` ローダー実装 (必須キー: `GOOGLE_DRIVE_TARGET_FOLDER_ID`, LLM/Embedding API キー, Supabase 接続情報, `felores/gdrive-mcp-server` のエンドポイント等)。
  - 不足している環境変数がある場合の起動時バリデーション。
- ロギング基盤
  - ログレベル (INFO/ERROR など) の設計と簡易ロガー実装。
  - クローラー / 検索 CLI から共通ロガーを利用できるようにする。

### フェーズ 2: Supabase / DB アクセス実装 (P0)

- Supabase 接続モジュール
  - 接続パラメータ (URL, API キー等) を `.env` から読み込む。
  - 接続エラー時にリトライまたはわかりやすいエラーメッセージを出力。
- テーブル操作レイヤ
  - `files` テーブルに対する CRUD 関数:
    - upsert (新規・更新共通)
    - 論理削除 or 削除マーク付与 (Drive 側削除への追従方法は PoC として簡易実装可)。
    - `file_id` 一覧によるベクトル検索実行 (フィルター付き pgvector 検索)。
  - `crawler_state` テーブルへの Start Page Token 保存 / 取得関数。
- ベクトル検索インターフェース
  - Embedding ベクトルを受け取り、上位 N 件を返すクエリ実装。
  - `file_id` のリストを IN 句 / サブクエリでフィルタリングする実装。

### フェーズ 3: LLM / Embedding クライアント実装 (P0)

- Embedding クライアント
  - `text-embedding-3-small` を前提とした API ラッパー実装。
  - 入力テキスト長の制御 (ファイル名 + 要約 + キーワード連結時のトークン数制限)。
- LLM クライアント
  - GPT-4o mini を前提とした汎用呼び出し関数。
  - プロンプトテンプレート管理:
    - ファイル要約生成用プロンプト。
    - 検索用キーワード抽出プロンプト (最大 3 件)。
    - 検索結果リランキング用プロンプト。
    - 絞り込みのための追加質問生成プロンプト。
- エラーハンドリング
  - タイムアウト / レート制限時のリトライ方針 (PoC のため簡易でよいがログには残す)。

### フェーズ 4: `felores/gdrive-mcp-server` クライアント実装 (P0)

- 共通クライアント
  - `felores/gdrive-mcp-server` の API 仕様に基づき、以下の操作をラップする:
    - ファイル一覧・メタデータ取得。
    - 全文検索 (キーワード・期間指定)。
    - ファイル本文取得。
  - 認証方式:
    - クローラー: サービスアカウント等、管理者権限ベースの認証。
    - 検索 CLI: 実行ユーザーの Google アカウント認証情報を利用。
- 差分取得用 API 利用
  - Start Page Token を利用した変更分取得 (`changes.list` 相当) のラップ。
  - 取得したトークンを `crawler_state` に保存する処理の実装。

### フェーズ 5: クローラー CLI 実装 (P0)

- CLI インターフェース設計
  - コマンド例: `document-locator crawl`。
  - オプション:
    - `--full` フルスキャン実行 (Start Page Token を無視して再取得)。
    - `--dry-run` DB 書き込みなしで処理フロー確認。
- クロール処理フロー
  - `GOOGLE_DRIVE_TARGET_FOLDER_ID` (複数指定対応) を読み込み、対象フォルダ配下のファイル一覧を取得。
  - Start Page Token が存在する場合は差分取得モード、存在しない場合は初回フル取得モード。
  - 取得した各ファイルについて:
    - メタデータ (ID, 名前, 更新日時など) の取得。
    - 本文の取得 (テキスト形式が前提、非対応形式はスキップ or 簡易ハンドリング)。
    - LLM で要約生成。
    - LLM でキーワード抽出 (最大 3 件)。
    - 「ファイル名 + 要約 + キーワード連結テキスト」を Embedding に変換。
    - Supabase の `files` テーブルに upsert。
  - 削除・アクセス不可ファイルへの対応:
    - Drive 側で削除されたファイルの扱い (DB 側で削除フラグを立てる等) を PoC として簡易定義。
  - 処理完了後、Start Page Token を更新。
- ロギング
  - 処理開始 / 終了時刻、対象フォルダ ID、処理件数 (新規・更新・削除) をログ出力。
  - LLM / API 呼び出しエラーは詳細をログに記録しつつ、可能な限り他ファイル処理は継続。

### フェーズ 6: セマンティック検索 CLI 実装 (P0)

- CLI インターフェース設計
  - コマンド例: `document-locator search "<クエリ>"`。
  - オプション:
    - `--from`, `--to` などの期間指定 (クエリ内からの自動抽出とは別に任意指定できるようにするかは PoC 中で検討)。
- クエリ前処理
  - ユーザー自然文クエリから以下を抽出:
    - 検索意図の簡易要約 (LLM)。
    - 検索用キーワード (最大 3 件; GPT-4o mini 利用)。
    - 期間フィルタ (日付表現の抽出と正規化)。
- 初期検索 (権限フィルタリングの実現)
  - `felores/gdrive-mcp-server` に対し、抽出したキーワードおよび期間フィルタを用いて全文検索を実行。
  - 戻り値として「ユーザー権限で閲覧可能なファイル ID のリスト」を取得。
- ヒット件数に応じた分岐ロジック実装
  - 101 件以上:
    - 上位結果のメタ情報を LLM に渡し、絞り込み用の追加質問文を生成。
    - CLI 上でユーザーに追加質問を提示し、回答を受け取る。
    - 回答から追加キーワードを 1 件抽出し、元キーワードと組み合わせて `felores/gdrive-mcp-server` で再検索。
  - 31〜100 件:
    - ヒットしたファイル ID 群をフィルタとして Supabase に対しベクトル検索を実行。
    - 関連度の高い上位約 30 件に絞り込む。
  - 11〜30 件:
    - 取得したファイル情報 (ファイル名・要約など) を LLM に渡し、ユーザー質問意図への合致度で 10 件に選抜。
  - 1〜10 件:
    - 同様に LLM でリランキングのみ行う。
  - 0 件:
    - キーワード数を減らすなどの自動調整で再検索。
    - キーワード 1 件になっても 0 件であれば「見つかりませんでした」を表示。
  - 上記分岐後のヒット件数が 10 件を超える場合、同様のロジックを再度適用し、最終的に 10 件以下になるまで繰り返し。
- 検索結果出力
  - ファイル名 / 要約文 / Google Drive URL / 更新日時 をテキスト形式で一覧表示。
  - 並び順: 最終的な LLM リランキング結果の順。

### フェーズ 7: 非機能要件対応 (P1)

- 性能
  - 代表的なクエリについて 30 秒以内に応答できるか簡易計測。
  - ベクトル検索の k (取得件数) 調整や LLM 呼び出し回数削減によるチューニング検討。
- 信頼性
  - クローラーでの一部失敗時にも処理継続する実装 (例: ファイル単位で try/catch)。
  - Start Page Token 不整合時のリカバリ:
    - フルスキャンに自動フォールバックするか、明示的な再同期コマンドを用意するかを検討。
- ログ・監視
  - 要件に記載の情報 (クエリ概要・要約・キーワードなど) をログに残す。
  - 将来の外部監視ツール連携を想定し、ログフォーマットをできるだけ一貫性のある形式にしておく。

### フェーズ 8: セキュリティ・運用 (P1)

- 認証・認可
  - Google OAuth 2.0 フローを CLI から扱うための運用方法を整理 (初回ログイン時のトークン保存場所など)。
  - クローラー用サービスアカウントの秘密鍵配置方法を決定 (ローカルファイル or 環境変数など)。
- 秘密情報の管理
  - `.env` や認証情報ファイルを Git 管理対象外にする設定確認。
  - ドキュメントに安全な管理方法を明記。
- ログのプライバシー配慮
  - ファイル本文や機密情報をログに直接含めないよう出力内容を制限。

## 4. マイルストーンと成果物

- マイルストーン 1: 基盤整備完了
  - CLI 雛形、設定ローダー、ロガー、Supabase 接続確認。
- マイルストーン 2: クローラー PoC 完了
  - 特定フォルダに対してクローラー CLI を実行し、Supabase に要約・キーワード・Embedding が保存される。
- マイルストーン 3: セマンティック検索 PoC 完了
  - 検索 CLI から自然文クエリを入力し、権限を考慮した検索結果が 10 件以下に絞られて表示される。
- マイルストーン 4: 非機能要件・運用整理
  - 性能測定・ログ仕様・認証運用の整理が完了し、README/ドキュメントに反映されている。
