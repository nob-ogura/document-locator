# 生成AIとベクトル検索を活かしたGoogle Drive検索システム 要件定義（PoC）

## 1. 文書の目的と位置づけ

- 本書は、「生成AIとベクトル検索を活用した次世代のGoogle Drive検索システム」PoC（概念実証版）の要件定義を示す。
- PoC の目的は、ヒット件数に応じて検索手段を切り替える「ハイブリッド検索」の有効性を、最小限の実装（MVP）で検証することとする。
- 本書の内容は、実装・テスト・運用設計のインプットとして利用される。

## 2. システム概要

### 2.1 システム名

- 名称：Google Drive 検索 CLI（以降「本システム」）

### 2.2 対象範囲

- 対象：単一ユーザーが自身の Google アカウント配下の Google Drive を検索するための CLI ツールと、そのためのインデックス作成基盤。
- 対象外：
  - 複数ユーザー／組織アカウントを跨いだ利用
  - Web UI や API サーバーなど、CLI 以外のフロントエンド
  - 本番運用レベルの監視・冗長構成・SLA 設定

### 2.3 想定利用者

- 自身の Google アカウントで Google Drive を日常的に使用している技術ユーザー。
- ターミナル上で CLI コマンドを実行できるユーザー。

### 2.4 用語定義（抜粋）

- PoC：概念実証。ビジネス価値や技術的成立性を検証することを主目的とする。
- MVP：Minimum Viable Product。価値検証に必要な最小限の機能セット。
- ハイブリッド検索：ベクトル検索（Supabase / pgvector）を起点に、ヒット件数や類似度に応じて LLM の絞り込み質問・リランキングを組み合わせる検索方式。
- ヒット件数：ベクトル検索結果のうち、類似度しきい値を超過したレコード件数。

## 3. 前提条件・非対象

### 3.1 セキュリティと権限モデル

- シングルユーザー環境を前提とし、検索を実行するユーザーと Google Drive クローラーは同一の Google アカウント認証情報を用いる。
- サービスアカウントなど、ユーザー本人以外の主体による Drive クローリングは本 PoC の対象外とする。
- クロール／検索対象は `.env` で指定する `GOOGLE_DRIVE_TARGET_FOLDER_IDS` に含まれる各フォルダと、そのサブフォルダ配下のファイルに限定する。

### 3.2 外部サービス

- Google Drive API
  - ターゲットフォルダ解決、差分クロール、候補ファイルの存在確認・権限確認などに使用する（検索の起点では使用しない）。
- LLM / Embeddings（OpenAI）
  - 推論用モデル：GPT-4o mini
  - ベクトル化モデル：text-embedding-3-small
- DB（Supabase）
  - PostgreSQL＋ `pgvector` 拡張機能を利用し、インデックス情報を保存する。

### 3.3 対象ファイル種別と非対象

- インデックス対象：
  - Google ドキュメント、PDF など、Google Drive API を通じてテキストコンテンツを取得可能なファイル。
- 非対象：
  - 画像（例：`.jpg`, `.png`, `.gif`）やその他バイナリ（例：`.zip`）はインデックス対象外とし、検索結果にも表示しない。
  - 画像内テキストを対象とした OCR 処理は行わない。

### 3.4 差分検出と制約

- 差分検出はファイルの `modifiedTime` を基準とし、「新規作成・更新」のみを追跡対象とする。
- Drive 上での削除・移動・権限変更は `modifiedTime` の変化に依存しないため、本 PoC では完全には検知しない。
- このため、 `drive_file_index` 上に「論理的には削除済み／移動済み／閲覧不可」となったファイルのレコードが残り続けること（インデックスの汚れ）を仕様として許容する。
- ベクトル検索を起点とするため、クロールでインデックスされていない新規ファイルは検索に出ず、権限変更・削除の反映にも遅延が生じる。
- `.env` 内のクロール対象条件（例：`GOOGLE_DRIVE_TARGET_FOLDER_IDS`）が変更された場合は、差分検出による更新は行わず、次回クロール実行時にフルスキャンからやり直すものとする。

### 3.5 実行環境

- 本 PoC で公式にサポートする OS は macOS とする。
- 上記以外の OS（例：Linux、Windows）は動作検証の対象外とする。

## 4. 機能要件（全体）

### 4.1 機能一覧

1. Google Drive クローラー（CLI / Cron 実行）
2. セマンティック検索 CLI
3. LLM を用いたキーワード抽出・追加質問生成・リランキング
4. ベクトル検索（Supabase＋pgvector）

### 4.2 共通要件

- `.env` ファイルに設定された各種環境変数（API キー、DB 接続情報、`GOOGLE_DRIVE_TARGET_FOLDER_IDS` 等）を利用して動作する。
- LLM にコンテキストとして渡すファイル情報は、ベクトル検索で得た `file_id` をベースとし、必要に応じて Drive API で存在・権限を確認した結果に限定する。

## 5. 機能要件：Google Drive クローラー

### 5.1 概要

- Google Drive を定期または手動で巡回し、検索用インデックス（DB）を構築・更新する CLI プログラムを提供する。
- Cron から実行できることを前提とする。

### 5.2 入力・出力

- 入力：
  - `.env` ファイルに定義された `GOOGLE_DRIVE_TARGET_FOLDER_IDS`（カンマ区切りで複数指定可能）。
  - Supabase への接続情報。
  - OpenAI API キー。
- 出力：
  - Supabase 内の `drive_file_index` テーブルへのインデックスレコード（Upsert）。
  - Supabase 内の `drive_sync_state` テーブルへの同期状態レコード更新。

### 5.3 処理フロー

1. ターゲットフォルダの解決
   - `GOOGLE_DRIVE_TARGET_FOLDER_IDS` で指定された各フォルダ ID について、Google Drive API で存在確認を行う。
   - フォルダが存在しない、または権限不足の場合は処理を即時失敗させ、クロールを開始しない。
2. 初回クロール（フルスキャン）
   - ターゲットフォルダを起点としてサブフォルダを再帰的にたどり、`files.list` により配下の全ファイルを取得する。
   - テキスト取得可能なファイルについて、後述の AI 処理を行い、`drive_file_index` に保存する。
   - 取得したファイル群の `modifiedTime` の最大値を `drive_sync_state.drive_modified_at` に保存する。
   - 前回クロール実行時から `GOOGLE_DRIVE_TARGET_FOLDER_IDS` 等のクロール対象条件が変更されている場合も、本フローを再度実行し、フルスキャンからやり直す。
3. 差分クロール
   - 2 回目以降は、`drive_sync_state.drive_modified_at` 以降に更新されたファイルを対象に、同様にターゲットフォルダ配下を再帰的に検索する。
   - 差分対象はテキスト取得可能なファイルの新規作成・更新に限定する。
4. AI 処理
   - 対象ファイルのテキストコンテンツを取得する。
   - GPT-4o mini を用いて、以下を生成する。
     - ファイル要約文（`summary`）
    - 検索用キーワード（`keywords`、1〜5件程度のキーワードを想定）
   - 「要約文＋キーワード＋ファイル名」を連結したテキストを text-embedding-3-small に入力し、ベクトル（`embedding`）を生成する。
   - 要約文（`summary`）は、設定ファイルに定義された最大文字数 M 文字以内となるように生成・切り詰める。
5. インデックス保存と同期状態更新
   - 取得した情報を `drive_file_index` テーブルに Upsert する。
   - 対象ファイル群の `modifiedTime` の最大値で `drive_sync_state.drive_modified_at` を更新する。

### 5.4 DB テーブル要件

- `drive_file_index` テーブル
  - カラム：
    - `file_id`: TEXT, PK
    - `file_name`: TEXT, NOT NULL
    - `summary`: TEXT, NOT NULL
    - `keywords`: TEXT[] （キーワード配列）
    - `embedding`: VECTOR, NOT NULL
    - `drive_modified_at`: TIMESTAMPTZ, NOT NULL（Google Drive の `modifiedTime`）
    - `mime_type`: TEXT, NOT NULL
- `drive_sync_state` テーブル
  - カラム：
    - `id`: TEXT, PK（`global` とし、システム全体で 1 件のみ）
    - `drive_modified_at`: TIMESTAMPTZ, NOT NULL（クロール済みファイル群の最大 `modifiedTime`）

## 6. 機能要件：セマンティック検索 CLI

### 6.1 概要

- ユーザーの自然文クエリを受け取り、ベクトル検索を起点に、ヒット件数と類似度に応じて LLM による絞り込み質問・リランキングを行う CLI アプリケーションを提供する。
- 中核機能は、以下 3 要素の組み合わせによるハイブリッド検索とする。
  - ベクトル検索（`drive_file_index.embedding`）
  - LLM によるキーワード抽出・質問生成・リランキング
  - 必要最小限の Drive API 呼び出し（存在確認・権限確認・メタ更新）

### 6.2 入力・出力

- 入力：
  - コマンドライン引数または対話入力で受け取る自然文クエリ。
    - クエリに日付・期間指定、ファイル種別指定が含まれる場合は検索オプションとして利用する。
  - 初期類似度しきい値（デフォルト 0.70）や最大取得件数（デフォルト 80 件）は設定可能とする。
- 出力：
  - 条件に合致したファイルの一覧（ヒット件数 2〜10 件の場合）。
    - 表示項目：ファイル名、要約文、Google Drive リンク。
  - ヒット件数が 1 件の場合は、該当ファイルのみ表示する。
  - ヒット件数が 0 件で再検索しても改善しない場合、「見つかりませんでした」と表示して終了する。

### 6.3 検索フロー

1. クエリ解析
   - 自然文クエリから期間指定（`modifiedTime`）とファイル種別指定（`mimeType`）を抽出する（任意）。
   - GPT-4o mini を用い、固有名詞やプロジェクト名を優先するプロンプトでキーワードを 1〜5 件抽出する。
2. Embedding 生成
   - 「ユーザー入力＋抽出キーワード」を text-embedding-3-small でベクトル化する。
   - 類似度しきい値の初期値を 0.70、最大取得件数を 80 件とする（設定で変更可）。
3. ベクトル検索
   - Supabase / pgvector 上の `drive_file_index.embedding` に対し、上記ベクトルで類似検索を実行する。
   - 期間・MIME フィルタを SQL 側で同時適用し、類似度順にソートする。
   - 類似度しきい値を超過した件数を「ヒット件数」と定義する。

### 6.4 ヒット件数・類似度に応じた分岐ロジック

1. ヒット件数が 50 件以上 または 最上位類似度 < 0.75（過大・曖昧ケース）
   - LLM で「追加の絞り込み質問」を 1 件生成し、CLI でユーザー入力を受け付ける。
   - 追加キーワードやフィルタを反映して再度 Embedding を生成し、類似度しきい値を 0.82 に引き上げて再検索する。
2. ヒット件数が 10〜49 件（中規模ケース）
   - 上位 20 件を保持し、類似度 0.75 未満は除外する。
   - 必要に応じて LLM によるクエリリライトを行い、同一フィルタで再Embedding・再検索する。
3. ヒット件数が 2〜9 件（LLM によるリランキング）
   - 候補ファイルの要約・メタデータを GPT-4o mini に渡し、「ユーザー意図への適合度」でソートする。
   - ソート結果に従ってファイル名・要約文・Google Drive リンクを一覧表示し、処理を終了する。
4. ヒット件数が 1 件
   - 該当ファイルのファイル名・要約文・Google Drive リンクを表示し、処理を終了する。
5. ヒット件数が 0 件（広げる）
   - 類似度しきい値を 0.60 まで緩和して再検索し、同時に LLM によるキーワード削減を行う。
   - 再検索でも 0 件の場合、「見つかりませんでした」と表示して終了する。
6. 繰り返し条件
   - 上記のうち結果を表示した場合は終了する。
   - それ以外は更新後の条件で 6.3 以降を繰り返す。ループ回数は `.env` の `SEARCH_MAX_LOOP_COUNT` を上限とし、上限到達時は「10 件以下に絞り込めませんでした。クエリを見直してください。」と出力して終了する。

### 6.5 Drive API の利用タイミング

- 検索の起点では Drive API による全文検索は行わない。
- ベクトル検索で得た候補の `file_id` に対し、必要に応じて Drive API を呼び出す。
  - 存在確認・権限確認（404/403 の場合は結果から除外し、インデックス汚れとして扱う）。
  - 最新の `modifiedTime` や `mimeType` を取得し、差異があればインデックス更新キューに積む。
  - `GOOGLE_DRIVE_TARGET_FOLDER_IDS` 配下であることを検証する。

## 7. 非機能要件（PoC 前提）

- PoC／MVP フェーズであるため、本番運用レベルの可用性・性能・スケーラビリティに関する数値目標は定めない。
- インデックス内容は Google Drive の状態と完全には一致しない可能性がある（削除／移動／権限変更の反映遅延を許容する）。
- 検索品質（関連度）は LLM およびベクトル検索の特性に依存し、すべてのクエリに対して最適な結果が得られることは保証しない。

## 8. 運用・設定要件

- `.env` ファイルに以下の項目を定義できること。
  - Google Drive API 関連設定（認証情報・`GOOGLE_DRIVE_TARGET_FOLDER_IDS` 等）
  - Supabase 接続情報
  - OpenAI API キー
  - 要約文の最大文字数 M（例：`SUMMARY_MAX_LENGTH`）など、AI 処理に関するパラメータ
  - 検索フローの最大ループ回数 N（例：`SEARCH_MAX_LOOP_COUNT`）
- クローラーは macOS 上で OS のタスクスケジューラ（cron）から定期実行できること。
- システムは、環境変数や設定ファイルの変更により、設定を切り替えられる構成とする。このうちクロール対象に関わる設定（例：`GOOGLE_DRIVE_TARGET_FOLDER_IDS`）を変更した場合は、次回クロール時にフルスキャンが実行されること。
